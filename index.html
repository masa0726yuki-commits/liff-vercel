<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ã¯ã˜ã‚ã¦ã® LIFF â€” Vercelç‰ˆ</title>

  <!-- LIFF SDKï¼ˆå…¬å¼CDNï¼‰ -->
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

  <!-- ç”»é¢è£…é£¾ï¼ˆã‚·ãƒ³ãƒ—ãƒ«CSSï¼‰ -->
  <style>
    :root{--bg1:#0f172a;--bg2:#1e293b;--acc:#06c755;--text:#e5e7eb;--muted:#94a3b8;--card:#0b1220aa;--border:#1f2937}
    *{box-sizing:border-box}html,body{height:100%}
    body{margin:0;font-family:system-ui,-apple-system,"Segoe UI","Noto Sans JP",sans-serif;color:var(--text);
      background: radial-gradient(1200px 800px at 10% -10%, #1f2937 0%, transparent 60%),
                 radial-gradient(1200px 800px at 100% 0%, #0ea5e9 0%, transparent 40%),
                 linear-gradient(180deg,var(--bg1),var(--bg2));
      display:flex;justify-content:center;align-items:center;padding:22px}
    .card{width:100%;max-width:820px;background:linear-gradient(180deg,rgba(255,255,255,.06),rgba(255,255,255,.02));
      border:1px solid var(--border);backdrop-filter: blur(10px);border-radius:18px;padding:22px;box-shadow:0 30px 80px rgba(0,0,0,.35)}
    header{display:flex;gap:14px;align-items:center;margin-bottom:12px}
    .logo{width:42px;height:42px;border-radius:12px;display:grid;place-items:center;background:#001b0a;color:#32d269;font-weight:700;border:1px solid #12361f;box-shadow:inset 0 0 30px #052e16}
    h1{font-size:clamp(20px,3.8vw,28px);margin:0;font-weight:700;letter-spacing:.02em}
    p.lead{margin:.25rem 0 1rem;color:var(--muted)}
    .badges{display:flex;gap:8px;flex-wrap:wrap;margin:2px 0 10px}
    .badge{font-size:12px;padding:5px 8px;border-radius:999px;border:1px solid var(--border);color:var(--muted);background:#0b1220}
    .grid{display:grid;gap:12px;grid-template-columns:repeat(3,minmax(0,1fr))}
    @media (max-width:640px){.grid{grid-template-columns:1fr 1fr}}
    .btn{width:100%;padding:14px 16px;border-radius:12px;border:1px solid var(--border);background:#0b1425;color:var(--text);font-weight:600;letter-spacing:.02em;cursor:pointer;transition:.15s;display:flex;justify-content:center;gap:.5rem;align-items:center}
    .btn:hover{transform:translateY(-1px);border-color:#2b3649}
    .btn.primary{background:var(--acc);border-color:#128a3d;color:#0a0f0c}
    .btn.ghost{background:transparent}
    .row{display:flex;gap:10px;margin:10px 0 14px}
    .row>*{flex:1}
    input[type="text"],select{padding:14px 12px;border-radius:12px;border:1px solid var(--border);background:#0b1425;color:var(--text)}
    .out{margin-top:12px;background:#0a1120;border:1px dashed #263042;color:#aab8d4;border-radius:14px;padding:14px;min-height:120px;white-space:pre-wrap;overflow:auto;font-family:ui-monospace,Menlo,Consolas,monospace;font-size:13px}
    .toast{position:fixed;inset:auto 16px 16px 16px;display:none;z-index:50;background:#0b1425;border:1px solid #1f2937;color:#e5e7eb;padding:12px 14px;border-radius:10px;box-shadow:0 20px 60px rgba(0,0,0,.4)}
    .toast.show{display:block;animation:fade .2s ease}@keyframes fade{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
    footer{display:flex;justify-content:space-between;align-items:center;margin-top:10px;color:var(--muted);font-size:12px}
    a.link{color:#9ecfff;text-decoration:none}

    /* Modal */
    .modal{position:fixed;inset:0;display:none;place-items:center;background:rgba(0,0,0,.45);z-index:60}
    .modal.show{display:grid}
    .sheet{width:min(860px,94vw);background:#0b1422;border:1px solid #243044;border-radius:16px;padding:18px;box-shadow:0 20px 120px rgba(0,0,0,.6)}
    .sheet h2{margin:0 0 10px 0}
    .grid2{display:grid;gap:10px;grid-template-columns:1fr 1fr}
    @media (max-width:640px){.grid2{grid-template-columns:1fr}}
    .sheet .row-btns{display:flex;gap:10px;justify-content:flex-end;margin-top:12px}
    .copy{position:absolute;top:10px;right:14px;cursor:pointer;font-size:14px;color:#aab8d4}
  </style>
</head>
<body>
  <div class="card">
    <header>
      <div class="logo">LIFF</div>
      <div>
        <h1>ã¯ã˜ã‚ã¦ã® LIFFï¼ˆVercel ç‰ˆï¼‰</h1>
        <p class="lead">ãƒ­ã‚°ã‚¤ãƒ³ â†’ ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«è¡¨ç¤º â†’ ãƒˆãƒ¼ã‚¯é€ä¿¡ã¾ã§æœ€å°æ§‹æˆã§ã€‚ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç™»éŒ²ã‚‚è¿½åŠ ï¼</p>
        <div class="badges">
          <span id="b-inclient" class="badge">inClient: -</span>
          <span id="b-loggedin" class="badge">loggedIn: -</span>
          <span class="badge">SDK v2</span>
        </div>
      </div>
    </header>

    <div class="grid">
      <button class="btn primary" id="btn-login">ãƒ­ã‚°ã‚¤ãƒ³</button>
      <button class="btn" id="btn-regrant">ãƒ­ã‚°ã‚¤ãƒ³ï¼ˆå†åŒæ„ï¼‰</button>
      <button class="btn ghost" id="btn-logout">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>

      <button class="btn" id="btn-profile">ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«è¡¨ç¤º</button>
      <button class="btn" id="btn-send">ãƒˆãƒ¼ã‚¯ã«é€ä¿¡</button>
      <button class="btn" id="btn-open-profile">ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç™»éŒ²</button>
    </div>

    <div class="row">
      <input id="msg" type="text" placeholder="é€ã‚‹ãƒ†ã‚­ã‚¹ãƒˆ" value="LIFFã‹ã‚‰ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡ãƒ†ã‚¹ãƒˆï¼" />
      <button id="btn-send2" class="btn">ã“ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’é€ã‚‹</button>
    </div>

    <div style="display:flex;justify-content:space-between;align-items:center">
      <div>ãƒ­ã‚°</div>
      <button id="btn-copy" class="copy">ğŸ“‹ ã‚³ãƒ”ãƒ¼</button>
    </div>
    <div id="out" class="out">--- å‡ºåŠ›ã‚¨ãƒªã‚¢ ---</div>

    <footer>
      <div>Â© Your Project</div>
      <div><a class="link" href="#" onclick="location.reload()">å†èª­ã¿è¾¼ã¿</a></div>
    </footer>
  </div>

  <!-- ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç™»éŒ²ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="modal" class="modal" aria-hidden="true">
    <div class="sheet">
      <h2>ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç™»éŒ²ï¼æ›´æ–°</h2>
      <div class="grid2">
        <div>
          <div style="font-size:12px;color:#94a3b8;margin-bottom:6px">ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ </div>
          <input id="f-nickname" type="text" placeholder="" />
        </div>
        <div>
          <div style="font-size:12px;color:#94a3b8;margin-bottom:6px">æœ¬å</div>
          <input id="f-realname" type="text" placeholder="" />
        </div>
        <div>
          <div style="font-size:12px;color:#94a3b8;margin-bottom:6px">é›»è©±ç•ªå·</div>
          <input id="f-phone" type="text" inputmode="tel" placeholder="" />
        </div>
        <div>
          <div style="font-size:12px;color:#94a3b8;margin-bottom:6px">æ€§åˆ¥</div>
          <select id="f-gender">
            <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
            <option>ç”·æ€§</option><option>å¥³æ€§</option><option>æœªå›ç­”</option>
          </select>
        </div>
        <div>
          <div style="font-size:12px;color:#94a3b8;margin-bottom:6px">ãƒãƒ‰ãƒŸãƒ³ãƒˆãƒ³ã®ãƒ¬ãƒ™ãƒ«</div>
          <select id="f-level">
            <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
            <option>åˆç´š</option><option>ä¸­ç´š</option><option>ä¸Šç´š</option>
          </select>
        </div>
        <div style="display:flex;align-items:flex-end">
          <label style="display:flex;gap:8px;align-items:center">
            <input id="f-rental" type="checkbox" /> ãƒ©ã‚±ãƒƒãƒˆãƒ¬ãƒ³ã‚¿ãƒ«å¸Œæœ›
          </label>
        </div>
      </div>
      <div class="row-btns">
        <button id="btn-submit" class="btn primary" style="min-width:120px">é€ä¿¡</button>
        <button id="btn-cancel" class="btn" style="min-width:120px">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      </div>
    </div>
  </div>

  <div id="toast" class="toast"></div>

  <script>
    // â˜…ã‚ãªãŸã® LIFF IDï¼ˆå‰ã«å…±æœ‰ã®ï¼š2008326025-1LYV0A5oï¼‰
    const LIFF_ID = "2008326025-1LYV0A5o";
    // é€ä¿¡å…ˆã¯ Vercel ã®ãƒ—ãƒ­ã‚­ã‚· APIï¼ˆâ†ã“ã‚ŒãŒé‡è¦ï¼‰
    const PROFILE_ENDPOINT = "/api/profile";

    const $ = s => document.querySelector(s);
    const print = (v, replace=false)=>{ const el=$('#out'); el.textContent = replace ? String(v) : (el.textContent + (el.textContent?'\\n':'') + v); el.scrollTop = el.scrollHeight; };
    const toast = t => { const el=$('#toast'); el.textContent=t; el.classList.add('show'); setTimeout(()=>el.classList.remove('show'),2200); };
    const updateBadges = ()=>{ $('#b-inclient').textContent='inClient: '+liff.isInClient(); $('#b-loggedin').textContent='loggedIn: '+liff.isLoggedIn(); };

    async function ensureLogin(){ if(!liff.isLoggedIn()){ liff.login(); return false; } return true; }

    async function initLiff(){
      if(!('liff' in window)){ print("LIFF SDKã‚’èª­ã¿è¾¼ã‚ã¾ã›ã‚“ã§ã—ãŸã€‚ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯/ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ãƒ–ãƒ­ãƒƒã‚«ãƒ¼ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚", true); return; }
      try{
        print("LIFF SDK èª­ã¿è¾¼ã¿OKã€‚åˆæœŸåŒ–ä¸­â€¦", true);
        await liff.init({ liffId: LIFF_ID });
        print("LIFFåˆæœŸåŒ–æˆåŠŸï¼ v="+(liff.getVersion?.()||""));
        updateBadges();
        print(`åˆæœŸçŠ¶æ…‹: loggedIn=${liff.isLoggedIn()}, inClient=${liff.isInClient()}`);
      }catch(e){
        print("åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼: " + e);
        console.error(e);
      }
    }

    function wireButtons(){
      // ãƒ­ã‚°ã‚³ãƒ”ãƒ¼
      $('#btn-copy').onclick = async ()=>{
        try{ await navigator.clipboard.writeText($('#out').textContent||''); toast('ãƒ­ã‚°ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ'); }catch{ toast('ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸ'); }
      };

      $('#btn-login').onclick  = ()=> { if(!liff.isLoggedIn()) liff.login(); else toast('ã™ã§ã«ãƒ­ã‚°ã‚¤ãƒ³æ¸ˆã¿'); };
      $('#btn-regrant').onclick= ()=> liff.login({ scope:['profile','openid','chat_message.write'], prompt:'consent' });
      $('#btn-logout').onclick = ()=> { if(liff.isLoggedIn()){ liff.logout(); location.reload(); } else toast('ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ã¾ã›ã‚“'); };

      $('#btn-profile').onclick = async ()=>{
        if(!(await ensureLogin())) return;
        try{
          const p = await liff.getProfile();
          print(JSON.stringify({ displayName:p.displayName, userId:p.userId, statusMessage:p.statusMessage||'' }, null, 2));
          toast('ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«å–å¾—');
        }catch(e){ print("getProfile å¤±æ•—: " + e); }
      };

      async function doSend(text){
        const ok = await ensureLogin(); if(!ok) return;
        if(!liff.isInClient()){ print("LINEã‚¢ãƒ—ãƒªå†…ã§é–‹ã„ã¦ãã ã•ã„ï¼ˆinClient=falseï¼‰"); toast('inClient=false'); return; }
        try{
          await liff.sendMessages([{ type:'text', text }]);
          print("[send] é€ä¿¡æˆåŠŸï¼");
          toast('é€ä¿¡ã—ã¾ã—ãŸ');
        }catch(e){
          const name = e?.name || e?.code || "Error";
          print("[send] é€ä¿¡å¤±æ•—: " + name + " " + (e?.message||""));
          console.error(e);
        }
      }
      $('#btn-send').onclick  = ()=> doSend("LIFFã‹ã‚‰ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡ãƒ†ã‚¹ãƒˆï¼");
      $('#btn-send2').onclick = ()=> doSend($('#msg').value);

      // ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç™»éŒ²ãƒ¢ãƒ¼ãƒ€ãƒ«
      $('#btn-open-profile').onclick = async ()=>{
        if(!(await ensureLogin())) return;
        // æ—¢çŸ¥æƒ…å ±ã‚’åˆæœŸè¡¨ç¤º
        try{
          const p = await liff.getProfile();
          $('#f-nickname').value = p.displayName || '';
        }catch{}
        $('#modal').classList.add('show');
      };
      $('#btn-cancel').onclick = ()=> $('#modal').classList.remove('show');

      // é€ä¿¡
      $('#btn-submit').onclick = async ()=>{
        if(!(await ensureLogin())) return;
        try{
          const p = await liff.getProfile();
          const payload = {
            userId: p.userId,
            displayName: p.displayName || '',
            nickname: $('#f-nickname').value.trim(),
            realname: $('#f-realname').value.trim(),
            phone: $('#f-phone').value.trim(),
            gender: $('#f-gender').value,
            level: $('#f-level').value,
            rental: $('#f-rental').checked ? 'TRUE' : 'FALSE'
          };

          print("[profile] POST " + PROFILE_ENDPOINT);
          const r = await fetch(PROFILE_ENDPOINT, {
            method: 'POST',
            headers: { 'Content-Type':'application/json' },
            body: JSON.stringify(payload)
          });

          // æˆåŠŸ/å¤±æ•—ã®æ˜ç¤º
          const text = await r.text();
          let data = null;
          try{ data = JSON.parse(text); }catch{}
          if(r.ok && (data?.ok || data?.result==='ok')){
            toast('ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚’ç™»éŒ²ã—ã¾ã—ãŸ'); print("[profile] ç™»éŒ²æˆåŠŸ");
            $('#modal').classList.remove('show');
          }else{
            toast('é€ä¿¡ã‚¨ãƒ©ãƒ¼: ' + (data?.error || r.status + ' ' + r.statusText));
            print("[profile] ã‚¨ãƒ©ãƒ¼å¿œç­”: " + text);
          }
        }catch(e){
          // ã“ã“ã«æ¥ã‚‹ã®ã¯ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ç³»ï¼ˆãƒ—ãƒ­ã‚­ã‚·ãŒæœªé…ç½®/ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆç­‰ï¼‰
          print("[profile] é€ä¿¡ä¾‹å¤–: " + (e?.message||e));
          toast('é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ');
        }
      };
    }

    wireButtons();
    initLiff();
  </script>
</body>
</html>
