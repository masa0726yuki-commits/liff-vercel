<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>はじめての LIFF — プロフィール登録・編集</title>

  <!-- LIFF SDK -->
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

  <style>
    :root{--bg1:#0f172a;--bg2:#1e293b;--acc:#06c755;--text:#e5e7eb;--muted:#94a3b8;--border:#1f2937}
    *{box-sizing:border-box}body{margin:0;font-family:system-ui,-apple-system,"Segoe UI","Noto Sans JP",sans-serif;color:var(--text);
    background:radial-gradient(1000px 600px at 10% -10%,#1f2937 0,transparent 60%),radial-gradient(1200px 800px at 100% 0,#0ea5e9 0,transparent 40%),linear-gradient(180deg,var(--bg1),var(--bg2));
    display:flex;justify-content:center;align-items:center;min-height:100vh;padding:20px}
    .card{max-width:820px;width:100%;background:rgba(255,255,255,.05);backdrop-filter:blur(12px);border-radius:18px;padding:22px;border:1px solid var(--border);box-shadow:0 20px 60px rgba(0,0,0,.4)}
    h1{margin:0 0 6px;font-size:1.4rem}
    .badge{font-size:12px;padding:4px 8px;border-radius:8px;border:1px solid var(--border);color:var(--muted)}
    .grid{display:grid;gap:12px;grid-template-columns:repeat(3,1fr)}
    @media(max-width:640px){.grid{grid-template-columns:1fr 1fr}}
    .btn{padding:12px 14px;border-radius:10px;border:1px solid var(--border);background:#0b1425;color:var(--text);font-weight:600;cursor:pointer;transition:.15s}
    .btn.primary{background:var(--acc);color:#0a0f0c}
    input,select{padding:10px;border-radius:10px;border:1px solid var(--border);background:#0b1425;color:var(--text);width:100%}
    .out{margin-top:10px;background:#0a1120;border:1px dashed #263042;padding:10px;font-size:13px;min-height:120px;white-space:pre-wrap;overflow:auto}
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;place-items:center;z-index:100}
    .modal.show{display:grid}
    .sheet{background:#0b1420;border-radius:12px;padding:20px;max-width:600px;width:90%}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media(max-width:600px){.grid2{grid-template-columns:1fr}}
    .toast{position:fixed;bottom:16px;left:50%;transform:translateX(-50%);background:#0b1425;color:#fff;padding:10px 14px;border-radius:10px;border:1px solid var(--border);display:none}
    .toast.show{display:block}
  </style>
</head>
<body>
  <div class="card">
    <h1>はじめての LIFF（プロフィール登録・編集対応）</h1>
    <div style="display:flex;gap:6px;margin-bottom:14px;">
      <span id="b-inclient" class="badge">inClient: -</span>
      <span id="b-loggedin" class="badge">loggedIn: -</span>
    </div>

    <div class="grid">
      <button class="btn primary" id="btn-login">ログイン</button>
      <button class="btn" id="btn-regrant">再同意ログイン</button>
      <button class="btn" id="btn-logout">ログアウト</button>
      <button class="btn" id="btn-send">トークに送信</button>
      <button class="btn" id="btn-diagnose">診断</button>
      <button class="btn" id="btn-profile-edit">プロフィール登録・編集</button>
    </div>

    <div style="margin-top:10px;display:flex;gap:8px;">
      <input id="msg" type="text" placeholder="送信するメッセージ" />
      <button id="btn-send2" class="btn">送信</button>
    </div>

    <div id="out" class="out">--- 出力エリア ---</div>
    <button id="btn-copy" class="btn" style="margin-top:10px;">ログをコピー</button>
  </div>

  <!-- プロフィール登録モーダル -->
  <div id="modal" class="modal">
    <div class="sheet">
      <h2>プロフィール登録・編集</h2>
      <div class="grid2">
        <div><label>ニックネーム</label><input id="pf-nickname" type="text"></div>
        <div><label>本名</label><input id="pf-realname" type="text"></div>
        <div><label>電話番号</label><input id="pf-phone" type="text" inputmode="numeric"></div>
        <div><label>性別</label>
          <select id="pf-gender">
            <option value="">未選択</option>
            <option value="男性">男性</option>
            <option value="女性">女性</option>
            <option value="その他">その他</option>
          </select>
        </div>
        <div><label>レベル</label>
          <select id="pf-level">
            <option value="">未選択</option>
            <option value="初級">初級</option>
            <option value="中級">中級</option>
            <option value="上級">上級</option>
          </select>
        </div>
        <div style="display:flex;align-items:end">
          <label><input id="pf-rental" type="checkbox"> ラケットレンタル希望</label>
        </div>
      </div>
      <div style="margin-top:12px;display:flex;justify-content:flex-end;gap:8px;">
        <button id="btn-submit" class="btn primary">送信</button>
        <button id="btn-cancel" class="btn">キャンセル</button>
      </div>
    </div>
  </div>

  <div id="toast" class="toast"></div>

  <script>
    const LIFF_ID = "2008326025-1LYV0A5o";
    // 重要：GAS へは直接行かず、必ず同一オリジンの Vercel プロキシを使う
    const PROFILE_ENDPOINT = "/api/profile";

    const $ = s => document.querySelector(s);
    const print = (v, replace=false)=>{ const el=$('#out'); el.textContent = replace ? v : (el.textContent ? el.textContent + "\n" : "") + v; el.scrollTop=el.scrollHeight; };
    const toast = t => { const el=$('#toast'); el.textContent=t; el.classList.add('show'); setTimeout(()=>el.classList.remove('show'),2000); };
    const updateBadges = ()=>{ $('#b-inclient').textContent='inClient: '+liff.isInClient(); $('#b-loggedin').textContent='loggedIn: '+liff.isLoggedIn(); };

    async function initLiff(){
      try{
        print("LIFF SDK 読み込みOK。初期化中…", true);
        await liff.init({ liffId: LIFF_ID });
        print("LIFF初期化成功！ v="+(liff.getVersion?.()||""));
        updateBadges();
        print(`初期状態: loggedIn=${liff.isLoggedIn()}, inClient=${liff.isInClient()}`);
      }catch(e){ print("初期化エラー:"+e); }
    }

    function wireButtons(){
      $('#btn-login').onclick   = ()=>{ if(!liff.isLoggedIn()) liff.login(); else toast('すでにログイン済み'); };
      $('#btn-regrant').onclick = ()=> liff.login({scope:['profile','chat_message.write'],prompt:'consent'});
      $('#btn-logout').onclick  = ()=>{ if(liff.isLoggedIn()){ liff.logout(); location.reload(); }};

      $('#btn-send').onclick  = ()=> sendText("LIFFからメッセージ送信テスト！");
      $('#btn-send2').onclick = ()=> sendText($('#msg').value||"");

      $('#btn-diagnose').onclick = async ()=>{
        const info = {
          loggedIn:liff.isLoggedIn(), inClient:liff.isInClient(),
          os:liff.getOS?.(), ver:liff.getVersion?.(), ctx:liff.getContext?.()
        };
        print(JSON.stringify(info,null,2));
      };

      $('#btn-copy').onclick = async ()=>{ try{ await navigator.clipboard.writeText($('#out').textContent||""); toast('コピーしました'); }catch{ toast('コピー失敗'); }};

      $('#btn-profile-edit').onclick = ()=> openProfileModal();
      $('#btn-cancel').onclick      = ()=> closeModal();
      $('#btn-submit').onclick      = ()=> submitProfile();
    }

    async function sendText(text){
      if(!liff.isLoggedIn()){ liff.login(); return; }
      if(!liff.isInClient()){ toast("LINE内で開いてください"); return; }
      try{
        await liff.sendMessages([{ type:'text', text }]);
        print("[send] 送信成功！");
      }catch(e){ print("[send] 失敗:"+e); }
    }

    // ===== プロフィール登録・編集 =====
    function openModal(){ $('#modal').classList.add('show'); }
    function closeModal(){ $('#modal').classList.remove('show'); }

    async function openProfileModal(){
      openModal();
      // 既定値クリア
      $('#pf-nickname').value=""; $('#pf-realname').value=""; $('#pf-phone').value="";
      $('#pf-gender').value=""; $('#pf-level').value=""; $('#pf-rental').checked=false;

      const uid = liff.getContext?.()?.userId;
      if(!uid){ print("[profile] userId取得不可"); return; }

      // ★ 取得は必ず /api/profile 経由（GET）
      try{
        const url = `${PROFILE_ENDPOINT}?userId=${encodeURIComponent(uid)}`;
        print("[profile] GET " + url);
        const r = await fetch(url, { method:'GET' });
        const j = await r.json();
        if(j?.ok && j.profile){
          const p = j.profile;
          $('#pf-nickname').value = p.nickname || "";
          $('#pf-realname').value = p.realname || "";
          $('#pf-phone').value    = p.phone    || "";
          $('#pf-gender').value   = p.gender   || "";
          $('#pf-level').value    = p.level    || "";
          $('#pf-rental').checked = !!p.rental;
          print("[profile] 取得成功");
        }else{
          print("[profile] 取得応答: " + JSON.stringify(j));
        }
      }catch(e){
        print("[profile] 取得例外: " + e);
      }
    }

    async function submitProfile(){
      const ctx  = liff.getContext?.();
      const prof = await liff.getProfile();

      const payload = {
        action:'save',
        userId: ctx?.userId || '',
        displayName: prof?.displayName || '',
        nickname: $('#pf-nickname').value.trim(),
        realname:  $('#pf-realname').value.trim(),
        phone:     $('#pf-phone').value.trim(),
        gender:    $('#pf-gender').value,
        level:     $('#pf-level').value,
        rental:    $('#pf-rental').checked
      };

      // ★ 保存も必ず /api/profile 経由（POST）
      try{
        print("[profile] POST " + PROFILE_ENDPOINT);
        const r = await fetch(PROFILE_ENDPOINT, {
          method:'POST',
          headers:{ 'Content-Type':'application/json' },
          body: JSON.stringify(payload)
        });
        const text = await r.text();
        let data = null; try{ data = JSON.parse(text); }catch{}
        if(r.ok && (data?.ok || data?.result==='ok')){
          toast('登録完了'); print("[profile] 登録成功"); closeModal();
        }else{
          toast('登録エラー'); print("[profile] エラー応答: " + text);
        }
      }catch(e){
        print("[profile] 送信例外: " + e);
        toast('送信失敗');
      }
    }

    wireButtons();
    initLiff();
  </script>
</body>
</html>
